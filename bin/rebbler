#!/usr/bin/env ruby

require 'bundler/setup'
require 'net/dns'
require 'pp'
require 'ostruct'
require 'optparse'

module RBL
  class Loader
    def self.file= file
      @@filename = file
    end

    def self.load
      @@filename ||= File.join(File.dirname(__FILE__), '..', 'rbls.txt')
      File.readlines(@@filename).sort
    end
  end
end

class Checker
  attr_accessor :ip

  def initialize(to_check)
    @ip = resolve_to_ip(to_check)
  end

  def resolve_to_ip name_to_lookup
    begin
      IPAddr.new(name_to_lookup)
    rescue ArgumentError => e
      Resolver(name_to_lookup).answer.first.address
    end
  end

  def check(&blk)
    rbls.each do |line|
      rbl_domain = line.strip
      name = name_to_lookup rbl_domain

      answer = resolver.query(name).answer
      if answer.length > 0
        rbl_response_code = answer.first.address
        text = resolver.query(name, Net::DNS::TXT).answer
        rbl_txt_message = text.first.nil? ? "" : text.first.txt
        yield({ rbl: rbl_domain, result: rbl_response_code, message: rbl_txt_message })
      else
        yield({ rbl: rbl_domain, result: "", message: 'Not Listed' })
      end
    end
  end

  def rbls
    @@rbls ||= RBL::Loader.load
  end

  def name_to_lookup(rbl_domain)
    ip.reverse.gsub(/in-addr.arpa/, rbl_domain)
  end

  def resolver
    @resolver ||= Net::DNS::Resolver.new(:nameservers => ['8.8.8.8','8.8.4.4'] * 10, :log_file => nil)
  end
end

def do_server
  puts "Running server..."
  require 'sinatra'
  require "sinatra/reloader" if development?
  require 'sinatra-websocket'
  require 'haml'
  require 'json'
  require 'rbconfig'

  set :server, 'thin'
  set :root, File.join(File.dirname(__FILE__), '..')


  get '/', provides: 'html' do
    haml :index
  end

  get '/req' do
    return unless request.websocket?

    request.websocket do |ws|
      ws.onopen do
      end

      ws.onmessage do |msg|
        thing = Thread.new do
          begin
            checker = Checker.new msg
            checker.check do |response|
              EM.next_tick { ws.send(response.to_json + "\n\n") }
            end
          rescue Exception => e
            puts e
            raise e
          end
          Thread.self.join
          ws.close()
        end
        thing.run
      end

      ws.onclose do
      end
    end
  end

  if RbConfig::CONFIG['host_os'] =~ /^darwin/
    sleep 5
    system("open http://localhost:4567/")
  end
end

def do_commandline
  format = "%-55s %-16s %-s"
  @checker.check do |response|
    response = OpenStruct.new response
    puts format % [ response.rbl, response.result, response.message ]
  end
end

def do_nagios_check(key)
  hits = []
  format = "%-55s %-16s %-s"

  @checker.check do |response|
    hits << OpenStruct.new(response)
  end

  
  hits = hits.reject { |v| v.result.to_s == "" }
  
  if hits.length == 0
    puts "OK: %s not listed on any RBLS" % [ key ]
    exit 0
  else
    puts "WARNING: %s listed on %s RBLS." % [ key, hits.length ]
    exit 2
  end
end

options = OpenStruct.new

OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename(__FILE__)} [options]"

  opts.on("-s", "--server", "Run web server") do |v|
    options.server = v
  end

  opts.on("-r", "--rbls=filename", "file of RBLs one per line") do |v|
    puts "Setting rbl list from #{v}"
    options.rbl_file = v
    RBL::Loader.file = v
  end

  opts.on("-n", "--nagios-check", "Nagios RBL check") do |v|
    options.nagios = v
  end
end.parse!



if options.server
  do_server
  exit 0
end



key = ARGV.first

if key == "" or key.nil?
  $stderr.puts "USAGE: %s {ip|hostname}" % [ File.basename(__FILE__) ]
  exit 1
end

@checker = Checker.new key

if options.nagios
  do_nagios_check(key)
else
  do_commandline
end

